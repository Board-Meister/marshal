var c=class l{constructor(){this.renderCount=0;this.registered={};this.loaded={};this.tagMap={};this.scope={};this.instanceMap=new WeakMap;this.register({type:"module",entry:{name:"marshal",namespace:"boardmeister",version:l.version,source:this}})}static{this.version="1.0.0"}addScope(e,t){if(this.scope[e])throw new Error('Variable with name "'+e+'" already exists');this.scope[e]=t}render(){this.renderCount++}register(e){this.registered[this.getModuleConstraint(e)]=e}getModuleConstraint(e){return e.entry.namespace+"/"+e.entry.name}get(e){return this.loaded[e]??null}async load(){let e=await Promise.all(this.generateLoadGroups(await this.loadScopes()));e.forEach(this.tagModules.bind(this)),e.forEach(this.instantiateModule.bind(this)),this.updateTagModules()}async loadScopes(){let e={},t={};for(let s in this.registered){let n=this.registered[s];n.type==="scope"?t[s]=n:e[s]=n}let o=this.orderModules(t);for(let s of o){let n=await this.retrieveModulePromise(s),r=n.module,{module:a,config:i}=n;if(this.mapInstance(i,a),typeof r?.default=="object")for(let d in r?.default)this.addScope(d,(r?.default)[d])}return e}updateTagModules(){for(let e in this.tagMap)this.tagMap[e].forEach(o=>{o.module=this.get(this.getModuleConstraint(o.config))})}tagModules(e){(e.config.tags??[]).forEach(t=>{if(typeof this.tagMap[t]>"u"&&(this.tagMap[t]=[]),this.isESClass(e.module.default)){this.tagMap[t].push({config:e.config,module:e.module.default});return}this.tagMap[t].push(e)})}instantiateModule(e){let{module:t,config:o}=e,s;if(typeof t!="function"&&t.default?s=t.default:s=t,!this.isESClass(s))return this.mapInstance(o,s),s;let n=this.loadDependencies(s,o);if(n===!1)return this.mapInstance(o,s),s;let r=new s(...o.entry.arguments??[]);return typeof r.inject=="function"&&n&&r.inject(n),this.mapInstance(o,r),r}mapInstance(e,t){let o=this.getModuleConstraint(e);delete this.registered[o],this.loaded[o]=t,this.instanceMap.set(t,e)}getMappedInstance(e){return this.instanceMap.get(e)}loadDependencies(e,t){if(typeof e.inject!="object")return;let o=e.inject,s={};for(let n in o){if(this.isTag(o[n])){let a=o[n].substring(1);typeof this.tagMap[a]>"u"&&(this.tagMap[a]=[]),s[n]=this.tagMap[a];continue}let r=o[n];if(!this.loaded[r])return console.error("Module "+this.getModuleConstraint(t)+" could not be loaded due to missing dependency: "+r),!1;s[n]=this.loaded[r]}return s}isESClass(e){return typeof e=="function"&&Object.getOwnPropertyDescriptor(e,"prototype")?.writable===!1}orderModules(e){let t=[],o={},s=Object.keys(e).length**2;for(;!this.isObjectEmpty(e);){if(s--,s<0)throw console.warn("Not registered in load groups",e),new Error("Infinite dependency detected, stopping script...");e:for(let n in e){let r=e[n],a=r.requires??[];for(let i of a)if(!this.isTag(i)){if(!o[i]&&!e[i]&&!this.loaded[i])throw new Error("Module "+n+" is requesting not present dependency: "+i);if(e[i])continue e}t.push(r),delete e[n],o[n]=!0}}return t}generateLoadGroups(e){let t=[];return this.orderModules(e).forEach(o=>{t.push(this.retrieveModulePromise(o))}),t}isTag(e){return/^![^\W.].*$/.test(e)}async import(e,t={}){let o=String(Math.random().toString(36).substring(2)),s=Object.assign({},this.scope,t);window[o]=s;let n="";for(let u in s)n+="const "+u+' = window["'+o+'"]["'+u+'"];';let r=await(await fetch(e)).text();r=n+r;let a=new Blob([r],{type:"text/javascript"}),i=URL.createObjectURL(a),d=await import(i);return delete window[o],URL.revokeObjectURL(i),d}importModule(e){return typeof e.entry.source=="string"?this.import(e.entry.source):Promise.resolve(e.entry.source)}async retrieveModulePromise(e){return e.lazy?new Promise(t=>{t({module:()=>new Promise(o=>{this.importModule(e).then(s=>{o(this.instantiateModule({module:s,config:e}))})}),config:e})}):new Promise(t=>{this.importModule(e).then(o=>{t({module:o,config:e})})})}isObjectEmpty(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}};export{c as default};
