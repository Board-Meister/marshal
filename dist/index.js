var d=class l{constructor(){this.registered={};this.loaded={};this.scope={};this.tagMap={};this.instanceMap=new WeakMap;this.register({type:"module",entry:{name:"marshal",namespace:"boardmeister",version:l.version,source:this}})}static{this.version="0.0.2"}addScope(e,t){if(this.scope[e])throw new Error('Variable with name "'+e+'" already exists');this.scope[e]=t}register(e){this.registered[this.getModuleConstraint(e)]=e}getModuleConstraint(e){return e.entry.namespace+"/"+e.entry.name}get(e){return this.loaded[e]??null}async load(){let e=await Promise.all(this.#l(await this.#a()));e.forEach(this.#d.bind(this)),e.forEach(this.#t.bind(this)),this.#c()}getResourceUrl(e,t){let o=this.getMappedInstance(e);if(!o?.resource)throw new Error("Provided module configuration is missing resource definition");return o.resource.src+t}asset(e,t){let o=this.getMappedInstance(e);if(!o?.asset)throw new Error("Provided module configuration is missing asset definition");return o.asset.src+t}getMappedInstance(e){return this.instanceMap.get(e)}async import(e,t={}){let o=String(Math.random().toString(36).substring(2)),s=Object.assign({},this.scope,t);window[o]=s;let r="";for(let u in s)r+="const "+u+' = window["'+o+'"]["'+u+'"];';let n=await(await fetch(e)).text();n=r+n;let a=new Blob([n],{type:"text/javascript"}),i=URL.createObjectURL(a),c=await import(i);return delete window[o],URL.revokeObjectURL(i),c}async#a(){let e={},t={};for(let s in this.registered){let r=this.registered[s];r.type==="scope"?t[s]=r:e[s]=r}let o=this.#s(t);for(let s of o){let r=await this.#i(s),n=r.module,{module:a,config:i}=r;if(this.#e(i,a),typeof n?.default=="object")for(let c in n?.default)this.addScope(c,(n?.default)[c])}return e}#c(){for(let e in this.tagMap)this.tagMap[e].forEach(o=>{o.module=this.get(this.getModuleConstraint(o.config))})}#d(e){(e.config.tags??[]).forEach(t=>{if(typeof this.tagMap[t]>"u"&&(this.tagMap[t]=[]),this.#o(e.module.default)){this.tagMap[t].push({config:e.config,module:e.module.default});return}this.tagMap[t].push(e)})}#t(e){let{module:t,config:o}=e,s;if(typeof t!="function"&&t.default?s=t.default:s=t,!this.#o(s))return this.#e(o,s),s;let r=this.#u(s,o);if(r===!1)return this.#e(o,s),s;let n=new s(...o.entry.arguments??[]);return typeof n.inject=="function"&&r&&n.inject(r),this.#e(o,n),n}#e(e,t){let o=this.getModuleConstraint(e);delete this.registered[o],this.loaded[o]=t,this.instanceMap.set(t,e)}#u(e,t){if(typeof e.inject!="object")return;let o=e.inject,s={};for(let r in o){if(this.#r(o[r])){let a=o[r].substring(1);typeof this.tagMap[a]>"u"&&(this.tagMap[a]=[]),s[r]=this.tagMap[a];continue}let n=o[r];if(!this.loaded[n])return console.error("Module "+this.getModuleConstraint(t)+" could not be loaded due to missing dependency: "+n),!1;s[r]=this.loaded[n]}return s}#o(e){return typeof e=="function"&&Object.getOwnPropertyDescriptor(e,"prototype")?.writable===!1}#s(e){let t=[],o={},s=Object.keys(e).length*2;for(;!this.#g(e);){if(s--,s<0)throw console.warn("Not registered in load groups",e),new Error("Infinite dependency detected, stopping script...");e:for(let r in e){let n=e[r],a=n.requires??[];for(let i of a)if(!this.#r(i)){if(!o[i]&&!e[i]&&!this.loaded[i])throw new Error("Module "+r+" is requesting not present dependency: "+i);if(e[i])continue e}t.push(n),delete e[r],o[r]=!0}}return t}#l(e){let t=[];return this.#s(e).forEach(o=>{t.push(this.#i(o))}),t}#r(e){return/^![^\W.].*$/.test(e)}#n(e){return typeof e.entry.source=="string"?this.import(e.entry.source):Promise.resolve(e.entry.source)}async#i(e){return e.lazy?new Promise(t=>{t({module:()=>new Promise(o=>{this.#n(e).then(s=>{o(this.#t({module:s,config:e}))})}),config:e})}):new Promise(t=>{this.#n(e).then(o=>{t({module:o,config:e})})})}#g(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}};export{d as default};
