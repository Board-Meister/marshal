var a=class l{constructor(){this.registered={};this.loaded={};this.scope={};this.#e={};this.#o=new WeakMap;this.register({type:"module",entry:{name:"marshal",namespace:"boardmeister",version:l.version,source:this}})}static{this.version="0.0.2"}#e;#o;addScope(e,t){if(this.scope[e])throw new Error('Variable with name "'+e+'" already exists');this.scope[e]=t}register(e){this.registered[this.getModuleConstraint(e)]=e}getModuleConstraint(e){return e.entry.namespace+"/"+e.entry.name}get(e){return this.loaded[e]??null}async load(){let e=await Promise.all(this.#l(await this.#d()));e.forEach(this.#a.bind(this)),e.forEach(this.#s.bind(this)),this.#c()}getResourceUrl(e,t){let o=this.getMappedInstance(e);if(!o?.resource)throw new Error("Provided module configuration is missing resource definition");return o.resource.src+t}asset(e,t){let o=this.getMappedInstance(e);if(!o?.asset)throw new Error("Provided module configuration is missing asset definition");return o.asset.src+t}async#d(){let e={},t={};for(let s in this.registered){let r=this.registered[s];r.type==="scope"?t[s]=r:e[s]=r}let o=this.#r(t);for(let s of o){let r=await this.#i(s),n=r.module,{module:d,config:i}=r;if(this.#t(i,d),typeof n?.default=="object")for(let c in n?.default)this.addScope(c,(n?.default)[c])}return e}#c(){for(let e in this.#e)this.#e[e].forEach(o=>{o.module=this.get(this.getModuleConstraint(o.config))})}#a(e){(e.config.tags??[]).forEach(t=>{if(typeof this.#e[t]>"u"&&(this.#e[t]=[]),this.isESClass(e.module.default)){this.#e[t].push({config:e.config,module:e.module.default});return}this.#e[t].push(e)})}#s(e){let{module:t,config:o}=e,s;if(typeof t!="function"&&t.default?s=t.default:s=t,!this.isESClass(s))return this.#t(o,s),s;let r=this.#u(s,o);if(r===!1)return this.#t(o,s),s;let n=new s(...o.entry.arguments??[]);return typeof n.inject=="function"&&r&&n.inject(r),this.#t(o,n),n}#t(e,t){let o=this.getModuleConstraint(e);delete this.registered[o],this.loaded[o]=t,this.#o.set(t,e)}getMappedInstance(e){return this.#o.get(e)}#u(e,t){if(typeof e.inject!="object")return;let o=e.inject,s={};for(let r in o){if(this.isTag(o[r])){let d=o[r].substring(1);typeof this.#e[d]>"u"&&(this.#e[d]=[]),s[r]=this.#e[d];continue}let n=o[r];if(!this.loaded[n])return console.error("Module "+this.getModuleConstraint(t)+" could not be loaded due to missing dependency: "+n),!1;s[r]=this.loaded[n]}return s}isESClass(e){return typeof e=="function"&&Object.getOwnPropertyDescriptor(e,"prototype")?.writable===!1}#r(e){let t=[],o={},s=Object.keys(e).length*2;for(;!this.#g(e);){if(s--,s<0)throw console.warn("Not registered in load groups",e),new Error("Infinite dependency detected, stopping script...");e:for(let r in e){let n=e[r],d=n.requires??[];for(let i of d)if(!this.isTag(i)){if(!o[i]&&!e[i]&&!this.loaded[i])throw new Error("Module "+r+" is requesting not present dependency: "+i);if(e[i])continue e}t.push(n),delete e[r],o[r]=!0}}return t}#l(e){let t=[];return this.#r(e).forEach(o=>{t.push(this.#i(o))}),t}isTag(e){return/^![^\W.].*$/.test(e)}async import(e,t={}){let o=String(Math.random().toString(36).substring(2)),s=Object.assign({},this.scope,t);window[o]=s;let r="";for(let u in s)r+="const "+u+' = window["'+o+'"]["'+u+'"];';let n=await(await fetch(e)).text();n=r+n;let d=new Blob([n],{type:"text/javascript"}),i=URL.createObjectURL(d),c=await import(i);return delete window[o],URL.revokeObjectURL(i),c}#n(e){return typeof e.entry.source=="string"?this.import(e.entry.source):Promise.resolve(e.entry.source)}async#i(e){return e.lazy?new Promise(t=>{t({module:()=>new Promise(o=>{this.#n(e).then(s=>{o(this.#s({module:s,config:e}))})}),config:e})}):new Promise(t=>{this.#n(e).then(o=>{t({module:o,config:e})})})}#g(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}};export{a as default};
